<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

	<style>
        body {
            font-family: 'Roboto', sans-serif;
            background-image: url('dall.png');
	 background-size: cover;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;

        }

        .profile-container {
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .profile-header {
            background: #6e8efb;
            color: #fff;
            padding: 20px 0;
        }

             .profile-info {
            text-align: left;
            padding: 10px;
        }

        .profile-info h1 {
            margin: 0;
        }

        .profile-info p {
            margin: 0;
        }

        .profile-details {
            text-align: left;
            padding: 20px;
        }

        .profile-details h2 {
            margin-top: 0;
        }

        .profile-fields {
            margin-top: 10px;
        }

        .profile-fields label {
            font-weight: bold;
        }

        .profile-fields input {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }

        .profile-actions {
            margin-top: 20px;
        }

        .profile-actions button {
            background: #6e8efb;
            color: white;
            border: none;
            font-weight: bold;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }

        /* Hover effect for profile buttons */
        .profile-actions button:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .calendar {
            padding: 20px;
        }

        /* Style for the training schedule */
        .training-schedule {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }

        /* Style for each training entry */
        .training-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Style for training details */
        .training-details {
            flex: 1;
            margin-left: 10px;
        }

        /* Style for cancel button */
        .cancel-button {
            background-color: #e74c3c;
        }
		
		.back-to-calendar {
    position: absolute;
    top: 10px;
    left: 10px;
}

.back-button {
    display: inline-block;
    background: #6e8efb;
    color: white;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.back-button:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transform: translateY(-2px);
    transition: transform 0.2s, box-shadow 0.2s;
}
/* Add this to your existing CSS */
.profile-edit-form {
    padding: 20px;
    border-top: 1px solid #e0e0e0; /* Adds a line to separate the section */
}

.profile-edit-form h2 {
    color: #333;
    font-size: 1.2em;
    margin-bottom: 20px;
}

.form-field {
    margin-bottom: 10px;
}

.form-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-field input {
    box-sizing: border-box; /* Dostosowuje padding i border do szerokości elementu */
    width: 100%; /* Szerokość inputa na 100% dostępnego miejsca */
    padding: 10px; /* Ustawia równy padding dla wszystkich inputów */
    border: 1px solid #ccc; /* Jednolite obramowanie */
    border-radius: 5px; /* Zaokrąglone rogi */
    margin-bottom: 10px; /* Odstęp między polami */
}

.form-button {
    background: #6e8efb;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
    width: 100%;
}

.form-button:hover {
    background: #6e8efb;
}
.profile-container {
    /* ...existing styles... */
    max-width: 400px; /* zmniejsz szerokość dla lepszego wyglądu na desktopach */
}

.profile-header {
    padding: 20px 0; /* zwiększ wypełnienie */
}

.profile-info, .profile-edit-form {
     margin: 0 auto; /* Centrowanie formularza */
    max-width: 90%; /* Maksymalna szerokość formularza */
}

.profile-actions button, .form-button {
    width: calc(100% - 40px); /* dopasuj szerokość przycisku do paddingu kontenera */
    margin: 10px 0; /* dodaj margines dla przycisków */
}

/* Dla responsywności */
@media (max-width: 768px) {
    .profile-container {
        width: 95%; /* szerokość kontenera na urządzeniach mobilnych */
        margin: 20px; /* dodaj margines na zewnątrz */
    }

    .profile-actions button, .form-button {
        width: calc(100% - 40px); /* dostosuj szerokość przycisku do paddingu kontenera */
    }
}

/* Efekty wskazujące dla przycisków */
.profile-actions button:hover, .form-button:hover {
    opacity: 0.9; /* delikatna zmiana przezroczystości */
}

/* Ikony dla pól */
.form-field label {
    display: flex;
    align-items: center;
}

.form-field i {
    margin-right: 5px; /* margines dla ikon */
}
@media (max-width: 768px) {
    .form-field input {
        width: 100%; /* Szerokość inputa na 100% dostępnego miejsca na mniejszych ekranach */
    }
}

/* Dropdown container */
.dropdown {
    position: absolute;
    top: 10px;
    left: 10px;
    display: inline-block;
}

/* Dropdown button */
.dropbtn {
    background-color: #6e8efb;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    border: none;
    cursor: pointer;
}

/* Dropdown content (hidden by default) */
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    color: #333;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {
    background-color: #6e8efb;
    color: white;
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
    display: block;
}

/* Style for the "Back to Calendar" link */
.back-button {
    display: none; /* Hide the original Back to Calendar button */
}

/* Style for the other links */
.google-calendar-button, .logout-button {
    display: none; /* Hide other buttons */
}


    </style>
</head>
<body>
<div class="dropdown">
    <button class="dropbtn"><span id="userName"></span><span class="arrow-down">&#9660;</span></button>
    <div class="dropdown-content">
        <a href="index.html">Kalendarz</a>
		<a id="trainerPanelLink" href="/panel.html" style="display: none;">Panel Trenera</a>
        <a href="#" id="logout">Wyloguj</a>
    </div>
</div>


<div class="profile-container">
    <div class="profile-header">
    <h1 id="welcomeMessage">Witaj, <span id="displayName">Name Surname</span></h1>
</div>

    
   <div class="profile-info">
    <p id="displayEmail"><i class="fas fa-envelope"></i> Email: t.staworzynski@protonmail.com</p>
	<br>
    <p id="displayPhone"><i class="fas fa-phone"></i> Tel: +48789387011</p>
	<br>
    <p id="totalSessions"><i class="fas fa-calendar-alt"></i> Wszystkich treningów: 1</p>
	<br>
	<p id="nextTraining"><i class="fas fa-clock"></i> Następny trening: <span id="nextTrainingDate"></span></p>
<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <!-- Reszta treści modala -->
    </div>
</div>
	
	<br>
	<div class="add-to-google-calendar">
    <a href="#" id="addToGoogleCalendarButton" class="google-calendar-button">
        <i class="fab fa-google"></i> Dodaj do kalendarza Google
    </a>
	<br>
</div>

</div>
    
	<div class="profile-edit-form">
    <h2>Edit Profile</h2>
    <form id="editProfileForm">
        <div class="form-field">
            <label for="firstName">Imię:</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>
        <div class="form-field">
            <label for="lastName">Nazwisko:</label>
            <input type="text" id="lastName" name="lastName" required>
        </div>
        <div class="form-field">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-field">
            <label for="phone">Telefon:</label>
            <input type="tel" id="phone" name="phone" required>
        </div>
        <button type="submit" class="form-button">Aktualizuj Profil</button>
    </form>
</div>
</div>

 <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAHZ6gQdYUSPFGJfW4dd5QH5IuOMG9PDnY",
        authDomain: "genius-f6a78.firebaseapp.com",
        projectId: "genius-f6a78",
        storageBucket: "genius-f6a78.appspot.com",
        messagingSenderId: "4413237203",
        appId: "1:4413237203:web:8ce44809d0b3dd0147b126"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Function to fetch and display user data
    const fetchAndDisplayUserData = async (userId) => {
        const userDocRef = doc(db, 'users', userId);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
            const userData = userDocSnap.data();
            document.getElementById('displayName').innerHTML = userData.firstName + ' ' + userData.lastName;
            document.getElementById('displayEmail').innerHTML = '<i class="fas fa-envelope"></i> Email: ' + userData.email;
            document.getElementById('displayPhone').innerHTML = '<i class="fas fa-phone"></i> Phone: ' + userData.phone;
            const bookingsQuery = query(collection(db, 'bookings'), where('userId', '==', userId));
            const bookingsSnapshot = await getDocs(bookingsQuery);
            const trainingCount = bookingsSnapshot.docs.length;
            document.getElementById('totalSessions').innerHTML = `<i class="fas fa-calendar-alt"></i> Total Training Sessions: ${trainingCount}`;
        } else {
            console.log("No such document!");
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            fetchAndDisplayUserData(user.uid);

            // Pobierz imię użytkownika z dokumentu w bazie danych Firebase
            const userDocRef = doc(db, 'users', user.uid);
            getDoc(userDocRef).then((userDocSnap) => {
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const userNameButton = document.getElementById('userName');
                    if (userNameButton) {
                        userNameButton.textContent = `Cześć ${userData.firstName || ''}`;
                    }
                }
            }).catch((error) => {
                console.error('Error fetching user data:', error);
            });

            const editProfileForm = document.getElementById('editProfileForm');
            editProfileForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const userDocRef = doc(db, 'users', user.uid);
                setDoc(userDocRef, {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone
                }, { merge: true }).then(() => {
                    console.log('Profile updated successfully');
                    alert('Profile updated successfully!');
                }).catch((error) => {
                    console.error('Error updating profile:', error);
                    alert('Error updating profile');
                });
            });
        } else {
            // User is signed out
            // Handle user state when not logged in if necessary
        }
    });
});





    // Definiowanie funkcji viewProfile
    function viewProfile(userId) {
        const modal = document.getElementById('profileModal'); // Upewnij się, że masz element modal w HTML
        const profileDetails = document.getElementById('profileDetails'); // I ten element również

        getDoc(doc(db, 'users', userId)).then(docSnap => {
            if (docSnap.exists()) {
                const userData = docSnap.data();
                profileDetails.innerHTML = `
                    <p>Imię: ${userData.firstName}</p>
                    <p>Nazwisko: ${userData.lastName}</p>
                    <p>Email: ${userData.email}</p>
                    <p>Telefon: ${userData.phone}</p>
                `;
                modal.style.display = 'block';
            } else {
                console.error('Nie znaleziono dokumentu użytkownika');
            }
        }).catch(error => {
            console.error('Błąd podczas pobierania danych użytkownika:', error);
        });
    }



    // Gdy użytkownik kliknie (x), zamknij modal
    const closeButton = document.querySelector('.close');
    const modal = document.getElementById('profileModal');

    if (closeButton && modal) {
        closeButton.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
		
		} else {
        console.error('Element .close lub #profileModal nie istnieje w DOM.');
    }

    // Eksportowanie viewProfile do globalnego zasięgu
    window.viewProfile = viewProfile;

    document.addEventListener('DOMContentLoaded', () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchAndDisplayUserData(user.uid);

                // Fetch user's bookings
const bookingsQuery = query(collection(db, 'bookings'), where('userId', '==', user.uid));
getDocs(bookingsQuery)
    .then((bookingsSnapshot) => {
        const now = new Date();
        let nextTraining = null;

        // Find the next training session
        bookingsSnapshot.forEach((bookingDoc) => {
            const bookingData = bookingDoc.data();
            // Uwzględnij strefę czasową - w tym przypadku zakładam UTC
            const trainingDate = new Date(bookingData.date + 'T' + bookingData.time + 'Z');

            // Check if the training is in the future and not canceled
            if (trainingDate > now && !bookingData.canceled) {
                if (!nextTraining || trainingDate < nextTraining.date) {
                    nextTraining = {
                        date: trainingDate,
                        type: bookingData.trainingType,
                    };
                }
            }
        });

        // Display the next training session information
        const nextTrainingElement = document.getElementById('nextTraining');
        if (nextTraining) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', timeZone: 'UTC' };
            const formattedDate = nextTraining.date.toLocaleDateString('pl-PL', options);
            const formattedTime = nextTraining.date.toLocaleTimeString('pl-PL', options);
            nextTrainingElement.innerHTML = `<i class="fas fa-clock"></i> Następny trening: ${formattedDate}, ${formattedTime}, ${nextTraining.type}`;
        } else {
            nextTrainingElement.innerHTML = `<i class="fas fa-clock"></i> Następny trening: Brak`;
        }
    })
    .catch((error) => {
        console.error('Error fetching bookings:', error);
    });


                // Rest of your code...
            } else {
                // User is signed out
                // Handle user state when not logged in if necessary
            }
        });
    });

    // Set onclick handler for the close button
    closeButton.onclick = function() {
        const modal = document.getElementById('profileModal');
        modal.style.display = "none";
    }
	
	// Dodaj obsługę kliknięcia przycisku "Dodaj do kalendarza Google"
const addToGoogleCalendarButton = document.getElementById('addToGoogleCalendarButton');
addToGoogleCalendarButton.addEventListener('click', () => {
    // Pobierz dane dotyczące następnego treningu
    const nextTrainingDateElement = document.getElementById('nextTrainingDate');
    const nextTrainingDate = nextTrainingDateElement.textContent;

    if (nextTrainingDate) {
        // Utwórz link do kalendarza Google z danymi treningu
        const eventTitle = "Następny trening"; // Tytuł wydarzenia
        const eventDate = nextTrainingDate; // Data wydarzenia (pobrana z elementu)

        // Utwórz link do kalendarza Google z odpowiednimi parametrami
        const googleCalendarLink = `https://www.google.com/calendar/render?action=TEMPLATE&text=${eventTitle}&dates=${eventDate}/${eventDate}`;

        // Otwórz link w nowym oknie lub zakładce
        window.open(googleCalendarLink, '_blank');
    } else {
        alert("Brak danych dotyczących następnego treningu.");
    }
});



</script>